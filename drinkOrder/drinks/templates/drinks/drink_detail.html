{% extends 'base.html' %}

{% block title %}{{ drink.name }} Details{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">{{ drink.name }}</h1>

{% if messages %}
    <div class="mb-6">
        {% for message in messages %}
            <p class="{% if message.tags == 'success' %}text-green-500{% else %}text-red-500{% endif %} text-center">{{ message }}</p>
        {% endfor %}
    </div>
{% endif %}

<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="mb-4">
        {% if drink.image %}
            <img src="{{ drink.image.url }}" alt="Image of {{ drink.name }}" class="w-64 h-64 object-cover rounded mx-auto">
        {% else %}
            <img src="https://th.bing.com/th/id/OIP.VXlACuVJ-LQ6pAEOZQGgggHaHa?cb=iwc1&rs=1&pid=ImgDetMain" alt="No image for {{ drink.name }}" class="w-64 h-64 object-cover rounded mx-auto">
        {% endif %}
    </div>
    <p class="text-green-600 font-bold mb-2">${{ drink.price }}</p>
    {% if drink.category %}
        <p class="text-gray-500 mb-2">Category: {{ drink.category.name }}</p>
    {% endif %}
</div>

<h2 class="text-2xl font-semibold mb-4">Reviews</h2>
{% if drink.reviews.all %}
    <div class="space-y-4 mb-6">
        {% for review in drink.reviews.all %}
            <div class="bg-gray-100 p-4 rounded-lg flex items-start">
                <div class="mr-4">
                    {% if review.customer.avatar %}
                        <img src="{{ review.customer.avatar.url }}" alt="Avatar of {{ review.customer.full_name|default:review.customer.username }}" class="w-12 h-12 rounded-full object-cover">
                    {% else %}
                        <img src="https://media.istockphoto.com/illustrations/blank-man-profile-head-icon-placeholder-illustration-id1298261537?k=20&m=1298261537&s=612x612&w=0&h=8plXnK6Ur3LGqG9s-Xt2ZZfKk6bI0IbzDZrNH9tr9Ok=" alt="No avatar for {{ review.customer.full_name|default:review.customer.username }}" class="w-12 h-12 rounded-full object-cover">
                    {% endif %}
                </div>
                <div class="flex-1">
                    <p class="text-yellow-500" aria-label="Rating: {{ review.rating }} stars">
                        {% for i in "12345" %}
                            {% if i|add:"0" <= review.rating %}
                                ⭐
                            {% else %}
                                ☆
                            {% endif %}
                        {% endfor %}
                    </p>
                    <p class="text-gray-600">{{ review.text|linebreaks }}</p>
                    <p class="text-gray-500 text-sm">By {{ review.customer.full_name }} on {{ review.created_on|date:"F j, Y" }}</p>
                    {% if user.is_authenticated and user.is_customer and review.customer == user %}
                        <div class="flex space-x-4 mt-2">
                            <a href="{% url 'drinks:review_edit' drink.id review.id %}" class="text-blue-500 hover:underline">Edit</a>
                            <form method="POST" action="{% url 'drinks:review_delete' drink.id review.id %}">
                                {% csrf_token %}
                                <button type="submit" class="text-red-500 hover:underline" aria-label="Delete review">Delete</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="text-gray-600 mb-6">No reviews yet.</p>
{% endif %}

{% if can_review %}
    <h2 class="text-2xl font-semibold mb-4">Write a Review</h2>
    <form method="POST" action="{% url 'drinks:review_create' drink.id %}" class="bg-white p-6 rounded-lg shadow-md">
        {% csrf_token %}
        {% for field in review_form %}
            <div class="mb-4">
                <label for="{{ field.id_for_label }}" class="block text-gray-700 mb-2">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                    <p class="text-red-500 text-sm">{{ field.errors.as_text }}</p>
                {% endif %}
            </div>
        {% endfor %}
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" aria-label="Submit review">Submit Review</button>
    </form>
{% elif user.is_authenticated and user.is_customer %}
    <p class="text-gray-600">You have already reviewed this drink.</p>
{% endif %}

{% if editing_review %}
    <h2 class="text-2xl font-semibold mb-4">Edit Your Review</h2>
    <form method="POST" action="{% url 'drinks:review_edit' drink.id editing_review.id %}" class="bg-white p-6 rounded-lg shadow-md">
        {% csrf_token %}
        {% for field in review_form %}
            <div class="mb-4">
                <label for="{{ field.id_for_label }}" class="block text-gray-700 mb-2">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                    <p class="text-red-500 text-sm">{{ field.errors.as_text }}</p>
                {% endif %}
            </div>
        {% endfor %}
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" aria-label="Update review">Update Review</button>
    </form>
{% endif %}
{% endblock %}